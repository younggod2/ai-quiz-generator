#!/bin/bash
# –°–∫—Ä–∏–ø—Ç –¥–ª—è —Å–±—Ä–æ—Å–∞ –≤—Å–µ—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫ Qoder

QODER_USER_DIR="$HOME/Library/Application Support/Qoder/User"
BACKUP_DIR="$HOME/Desktop/Qoder_Settings_Backup_$(date +%Y%m%d_%H%M%S)"

echo "=== –°–±—Ä–æ—Å –Ω–∞—Å—Ç—Ä–æ–µ–∫ Qoder ==="
echo ""

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –ø–∞–ø–∫–∞ Qoder
if [ ! -d "$QODER_USER_DIR" ]; then
    echo "‚ùå –ü–∞–ø–∫–∞ Qoder –Ω–µ –Ω–∞–π–¥–µ–Ω–∞: $QODER_USER_DIR"
    exit 1
fi

echo "üìÅ –ü–∞–ø–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫: $QODER_USER_DIR"
echo ""

# –°–æ–∑–¥–∞—ë–º —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é
echo "üíæ –°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏..."
mkdir -p "$BACKUP_DIR"
cp -r "$QODER_USER_DIR"/* "$BACKUP_DIR/" 2>/dev/null
echo "‚úì –†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è —Å–æ–∑–¥–∞–Ω–∞: $BACKUP_DIR"
echo ""

# –ü–æ–∫–∞–∑—ã–≤–∞–µ–º, —á—Ç–æ –±—É–¥–µ—Ç —É–¥–∞–ª–µ–Ω–æ
echo "üìã –§–∞–π–ª—ã, –∫–æ—Ç–æ—Ä—ã–µ –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã/—Å–±—Ä–æ—à–µ–Ω—ã:"
echo "  - settings.json (–Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞)"
echo "  - keybindings.json (–≥–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏)"
echo "  - app.json (–Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è Qoder)"
echo "  - globalStorage/ (–≥–ª–æ–±–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ)"
echo "  - History/ (–∏—Å—Ç–æ—Ä–∏—è —Ñ–∞–π–ª–æ–≤)"
echo "  - snippets/ (—Å–Ω–∏–ø–ø–µ—Ç—ã)"
echo "  - workspaceStorage/ (–Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Ä–∞–±–æ—á–∏—Ö –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤)"
echo ""

read -p "‚ö†Ô∏è  –í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Å–±—Ä–æ—Å–∏—Ç—å –í–°–ï –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Qoder? (yes/no): " -r
echo ""

if [[ ! $REPLY =~ ^[Yy][Ee][Ss]$ ]]; then
    echo "‚ùå –û–ø–µ—Ä–∞—Ü–∏—è –æ—Ç–º–µ–Ω–µ–Ω–∞"
    exit 0
fi

# –ó–∞–∫—Ä—ã–≤–∞–µ–º Qoder, –µ—Å–ª–∏ –æ–Ω –∑–∞–ø—É—â–µ–Ω
echo "üîí –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–ø—É—â–µ–Ω–Ω—ã—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ Qoder..."
if pgrep -f "Qoder" > /dev/null; then
    echo "‚ö†Ô∏è  Qoder –∑–∞–ø—É—â–µ–Ω. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–∫—Ä–æ–π—Ç–µ Qoder –ø–µ—Ä–µ–¥ —Å–±—Ä–æ—Å–æ–º –Ω–∞—Å—Ç—Ä–æ–µ–∫."
    echo "   –ò–ª–∏ –Ω–∞–∂–º–∏—Ç–µ Enter, —á—Ç–æ–±—ã –ø–æ–ø—ã—Ç–∞—Ç—å—Å—è –∑–∞–∫—Ä—ã—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏..."
    read
    killall Qoder 2>/dev/null
    sleep 2
fi

# –£–¥–∞–ª—è–µ–º —Ñ–∞–π–ª—ã –Ω–∞—Å—Ç—Ä–æ–µ–∫
echo "üóëÔ∏è  –£–¥–∞–ª–µ–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ –Ω–∞—Å—Ç—Ä–æ–µ–∫..."

# –£–¥–∞–ª—è–µ–º –æ—Å–Ω–æ–≤–Ω—ã–µ —Ñ–∞–π–ª—ã
rm -f "$QODER_USER_DIR/settings.json"
rm -f "$QODER_USER_DIR/keybindings.json"
rm -f "$QODER_USER_DIR/app.json"

# –£–¥–∞–ª—è–µ–º –ø–∞–ø–∫–∏
rm -rf "$QODER_USER_DIR/globalStorage"
rm -rf "$QODER_USER_DIR/History"
rm -rf "$QODER_USER_DIR/snippets"
rm -rf "$QODER_USER_DIR/workspaceStorage"

# –°–æ–∑–¥–∞—ë–º –ø—É—Å—Ç—ã–µ –ø–∞–ø–∫–∏ –æ–±—Ä–∞—Ç–Ω–æ (—á—Ç–æ–±—ã Qoder –Ω–µ —Ä—É–≥–∞–ª—Å—è)
mkdir -p "$QODER_USER_DIR/globalStorage"
mkdir -p "$QODER_USER_DIR/History"
mkdir -p "$QODER_USER_DIR/snippets"
mkdir -p "$QODER_USER_DIR/workspaceStorage"

echo "‚úì –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–±—Ä–æ—à–µ–Ω—ã!"
echo ""
echo "‚úÖ –ì–æ—Ç–æ–≤–æ! –í—Å–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Qoder –±—ã–ª–∏ —Å–±—Ä–æ—à–µ–Ω—ã."
echo "üì¶ –†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –≤: $BACKUP_DIR"
echo ""
echo "üí° –¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ:"
echo "   1. –ó–∞–ø—É—Å—Ç–∏—Ç—å Qoder - –æ–Ω –æ—Ç–∫—Ä–æ–µ—Ç—Å—è —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é"
echo "   2. –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–∑ Cursor (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)"
echo "   3. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–∑ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏ (–µ—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫)"

