const { PDFDocument, rgb } = require('pdf-lib');
const fs = require('fs');
const path = require('path');

/**
 * Генерирует тестовый PDF файл для E2E тестов
 */
async function generateTestPDF() {
  const pdfDoc = await PDFDocument.create();
  
  // Текст для генерации вопросов - достаточно контента для создания тестов
  const content = [
    {
      title: 'Введение в программирование',
      text: `Программирование - это процесс создания компьютерных программ с использованием языков программирования. 
Языки программирования предоставляют набор правил и синтаксиса для написания кода, который компьютер может понять и выполнить.

Основные концепции программирования включают переменные, функции, циклы и условия. Переменные используются для хранения данных, 
функции - для организации кода в переиспользуемые блоки, циклы - для повторения операций, а условия - для принятия решений.

Объектно-ориентированное программирование (ООП) является популярным подходом к разработке программного обеспечения. 
ООП основано на концепциях классов и объектов. Класс определяет структуру и поведение объектов, а объект является экземпляром класса.

Алгоритмы и структуры данных являются фундаментальными концепциями в программировании. Алгоритм - это последовательность шагов 
для решения задачи, а структура данных - это способ организации и хранения данных в памяти компьютера.`
    },
    {
      title: 'Веб-разработка',
      text: `Веб-разработка включает создание веб-сайтов и веб-приложений. Существует два основных направления: 
frontend и backend разработка.

Frontend разработка фокусируется на пользовательском интерфейсе и взаимодействии с пользователем. 
Основные технологии включают HTML для структуры, CSS для стилизации и JavaScript для интерактивности.

Backend разработка отвечает за серверную логику, базы данных и API. Популярные технологии включают Node.js, Python, 
Java и различные фреймворки для создания серверных приложений.

Современная веб-разработка часто использует фреймворки и библиотеки, такие как React, Vue.js, Angular для frontend, 
и Express, Django, Spring для backend. Эти инструменты упрощают разработку и повышают производительность.

Базы данных играют важную роль в веб-разработке. Реляционные базы данных, такие как PostgreSQL и MySQL, используют таблицы 
и связи между ними. NoSQL базы данных, такие как MongoDB, используют документы и более гибкую структуру.`
    },
    {
      title: 'Тестирование и качество кода',
      text: `Тестирование является критически важной частью разработки программного обеспечения. 
Существует несколько типов тестирования: unit-тесты, интеграционные тесты и end-to-end тесты.

Unit-тесты проверяют отдельные компоненты или функции в изоляции. Они должны быть быстрыми и изолированными. 
Интеграционные тесты проверяют взаимодействие между различными компонентами системы.

End-to-end тесты проверяют полный пользовательский сценарий от начала до конца. Они имитируют реальное использование 
приложения пользователем и проверяют, что все компоненты работают вместе корректно.

Качество кода включает не только отсутствие ошибок, но и читаемость, поддерживаемость и производительность. 
Code review, рефакторинг и использование линтеров помогают поддерживать высокое качество кода.

Версионирование кода с использованием систем контроля версий, таких как Git, позволяет отслеживать изменения, 
сотрудничать с другими разработчиками и управлять различными версиями проекта.`
    }
  ];

  // Добавляем страницы с контентом
  for (const section of content) {
    const page = pdfDoc.addPage([595, 842]); // A4 размер
    const { width, height } = page.getSize();
    
    // Заголовок
    page.drawText(section.title, {
      x: 50,
      y: height - 50,
      size: 20,
      color: rgb(0, 0, 0),
    });
    
    // Текст разбиваем на строки
    const fontSize = 12;
    const lineHeight = 15;
    const margin = 50;
    const maxWidth = width - 2 * margin;
    let y = height - 100;
    
    const words = section.text.split(' ');
    let currentLine = '';
    
    for (const word of words) {
      const testLine = currentLine + (currentLine ? ' ' : '') + word;
      const textWidth = fontSize * testLine.length * 0.6; // Приблизительная ширина
      
      if (textWidth > maxWidth && currentLine) {
        page.drawText(currentLine, {
          x: margin,
          y: y,
          size: fontSize,
          color: rgb(0, 0, 0),
        });
        y -= lineHeight;
        currentLine = word;
        
        // Если страница закончилась, создаем новую
        if (y < 50) {
          const newPage = pdfDoc.addPage([595, 842]);
          y = height - 50;
        }
      } else {
        currentLine = testLine;
      }
    }
    
    // Добавляем последнюю строку
    if (currentLine) {
      page.drawText(currentLine, {
        x: margin,
        y: y,
        size: fontSize,
        color: rgb(0, 0, 0),
      });
    }
  }

  // Сохраняем PDF
  const pdfBytes = await pdfDoc.save();
  const outputPath = path.join(__dirname, '../e2e/fixtures/sample.pdf');
  
  // Создаем директорию, если её нет
  const fixturesDir = path.dirname(outputPath);
  if (!fs.existsSync(fixturesDir)) {
    fs.mkdirSync(fixturesDir, { recursive: true });
  }
  
  fs.writeFileSync(outputPath, pdfBytes);
  console.log(`✅ Тестовый PDF создан: ${outputPath}`);
}

// Запускаем генерацию
generateTestPDF().catch(console.error);

